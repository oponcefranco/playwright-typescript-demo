version: 2.1

orbs:
  node: circleci/node@5.1.0
  browser-tools: circleci/browser-tools@1.4.6
  slack: circleci/slack@4.12.0

jobs:
  build-and-test:
    docker:
      - image: cimg/node:18.20-browsers
    steps:
      - checkout

      - browser-tools/install-chrome
      - browser-tools/install-chromedriver

      - node/install-packages:
          pkg-manager: npm

      - run:
          name: Install Playwright browsers
          command: npx playwright install --with-deps

      - run:
          name: Run ESLint
          command: npm run eslint-check-only

      - run:
          name: Run Prettier check
          command: npx prettier --check .

      - run:
          name: Run Playwright tests
          command: npm run test:chromium

      - run:
          name: Debug - List generated files
          command: |
            echo "=== Workspace contents ==="
            ls -la
            echo "=== Looking for reports ==="
            find . -name "*.xml" -o -name "*.html" -o -type d -name "*report*" -o -type d -name "*results*" | head -20
          when: always

      - run:
          name: Compress reports
          command: |
            if [ -d "playwright-report" ]; then
              tar -czf playwright-report.tar.gz playwright-report/
            fi
            if [ -d "test-results" ]; then
              tar -czf test-results.tar.gz test-results/
            fi
            if [ -d "junit-results" ]; then
              tar -czf junit-results.tar.gz junit-results/
            fi
          when: always

      - store_artifacts:
          path: playwright-report.tar.gz
          destination: reports/playwright-report.tar.gz
          when: always

      - store_artifacts:
          path: test-results.tar.gz
          destination: reports/test-results.tar.gz
          when: always

      - store_artifacts:
          path: junit-results.tar.gz
          destination: reports/junit-results.tar.gz
          when: always

      - slack/notify:
          event: pass
          template: basic_success_1

      - slack/notify:
          event: fail
          template: basic_fail_1

workflows:
  version: 2
  build-and-test:
    jobs:
      - build-and-test:
          context: slack-secrets
